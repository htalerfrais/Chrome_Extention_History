---
alwaysApply: true
---
# Current Architecture - Chrome Extension History Project

> **âš ï¸ IMPORTANT**: This document must be updated whenever the architecture is modified, components are added/removed, or significant structural changes are made to the project.

## Overview

This is a **Chrome Extension + React Frontend + Backend API** system that analyzes browsing history and organizes it into thematic sessions using AI-powered LLM services. The architecture follows a modern client-server pattern with React UI, extension services bridge, and remote AI analysis capabilities.

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHROME EXTENSION (Frontend)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Background Service Worker  â”‚  Popup Interface  â”‚  React Dashboardâ”‚
â”‚  - Data Collection          â”‚  - Quick Search   â”‚  - Modern UI    â”‚
â”‚  - Real-time Updates       â”‚  - History Lookup â”‚  - State Mgmt   â”‚
â”‚  - Local Storage           â”‚  - Simple UI      â”‚  - Component Treeâ”‚
â”‚                             â”‚                   â”‚  - ExtensionBridgeâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ ExtensionBridge Pattern
                                â”‚ (React â†” Extension Services)
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXTENSION SERVICES LAYER                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Session Management  â”‚  API Client       â”‚  Data Processing    â”‚
â”‚  - session_mgmt.js   â”‚  - api_client.js  â”‚  - preprocess.js   â”‚
â”‚  - Time grouping     â”‚  - HTTP comm      â”‚  - URL filtering   â”‚
â”‚  - API formatting    â”‚  - Error handling â”‚  - Feature extract â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ HTTP API Calls
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND API (Python FastAPI)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  FastAPI Server  â”‚  Clustering Service  â”‚  LLM Service         â”‚
â”‚  - REST Endpointsâ”‚  - Theme Detection   â”‚  - AI Text Generationâ”‚
â”‚  - Health Checks â”‚  - Pattern Analysis  â”‚  - Multi-Provider   â”‚
â”‚  - CORS Support  â”‚  - Keyword Matching  â”‚  - Provider Abstractionâ”‚
â”‚                  â”‚  - Session Clusteringâ”‚  - OpenAI/Anthropic â”‚
â”‚                  â”‚                      â”‚  - Google/Ollama    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ Data Models & Validation
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA LAYER (Pydantic Models)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Session Models  â”‚  LLM Models         â”‚  Validation           â”‚
â”‚  - HistoryItem   â”‚  - LLMRequest       â”‚  - Type Safety        â”‚
â”‚  - HistorySessionâ”‚  - LLMResponse      â”‚  - Input Validation   â”‚
â”‚  - ClusterResult â”‚  - Provider Support â”‚  - Error Handling    â”‚
â”‚  - ClusteringRespâ”‚  - Multi-Provider   â”‚  - Schema Validation  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Responsibilities

### **Frontend (Chrome Extension + React)**

#### **Background Service Worker** (`background.js`)
- **Responsibility**: Continuous data collection and preprocessing
- **Key Functions**:
  - Collects Chrome history data (up to 5000 items)
  - Real-time updates via `chrome.history.onVisited` listener
  - Stores preprocessed data in `chrome.storage.local`
  - Applies URL filtering and deduplication

#### **Popup Interface** (`popup.html`, `popup.js`)
- **Responsibility**: Quick access search interface
- **Key Functions**:
  - Simple search functionality across stored history
  - Displays search results with favicons and metadata
  - Provides access to React dashboard
  - Compact 320px width design

#### **React Dashboard** (`frontend/src/`)
- **Responsibility**: Modern UI with comprehensive analysis and visualization
- **Key Functions**:
  - **App Component**: Main state management and ExtensionBridge integration
  - **Header Component**: Logo, title, and action buttons with click handlers
  - **StatusBar Component**: Real-time status updates with loading/success/error states
  - **Dashboard Component**: Main content area for session and cluster display
  - **LoadingSpinner & ErrorDisplay**: User feedback components
  - **ExtensionBridge Service**: Clean interface to extension services

#### **Extension Services Bridge** (`frontend/src/services/extensionBridge.ts`)
- **Responsibility**: Connect React UI to existing extension services
- **Key Functions**:
  - Access Chrome storage and APIs
  - Use existing SessionManager for data processing
  - Use existing ApiClient for backend communication
  - Provide type-safe interface for React components
  - Handle service initialization and error recovery

#### **Data Processing Layer** (`extension/utils/`)
- **Session Manager** (`session_management.js`):
  - Groups history items into time-based sessions (120min gap)
  - Formats data for API consumption
  - Handles session statistics and validation
- **History Preprocessor** (`preprocess_history.js`):
  - URL normalization and cleaning
  - Duplicate detection and removal
  - Feature extraction (hostname, path, search queries)
  - Date formatting and enrichment

#### **API Client** (`extension/api/`)
- **API Client** (`api_client.js`):
  - Handles HTTP communication with backend
  - Implements retry logic and error handling
  - Manages request timeouts and failures
- **Configuration** (`config.js`):
  - Environment management (dev/production)
  - API endpoint configuration
  - Request settings and timeouts

### **Backend (Python FastAPI)**

#### **API Server** (`main.py`)
- **Responsibility**: RESTful API endpoints and request handling
- **Key Functions**:
  - Health check endpoints (`/`, `/health`)
  - Clustering endpoint (`/cluster`)
  - LLM text generation endpoint (`/llm/generate`)
  - CORS configuration for Chrome extension
  - Error handling and logging

#### **Clustering Service** (`clustering_service.py`)
- **Responsibility**: LLM-driven thematic clustering and session analysis
- **Key Functions**:
  - **LLM-powered cluster identification**: Uses AI to propose thematic clusters per session
  - **Intelligent item assignment**: Batched LLM calls to assign items to identified clusters
  - **Session-based processing**: Processes each session independently for personalized clustering
  - **Robust error handling**: Fallback mechanisms for LLM failures
  - **JSON extraction**: Parses LLM responses with error recovery
  - **Batch optimization**: Groups items for efficient LLM API usage

#### **LLM Service** (`llm_service.py`)
- **Responsibility**: AI-powered text generation and analysis
- **Key Functions**:
  - Multi-provider LLM abstraction
  - Provider management and routing
  - Request validation and error handling
  - Usage tracking and metadata extraction

#### **LLM Providers** (`providers/`)
- **Provider Interface** (`base_provider.py`):
  - Abstract base class for all LLM providers
  - Standardized interface for text generation
  - Request validation and model management
- **OpenAI Provider** (`openai_provider.py`):
  - GPT models integration (GPT-3.5, GPT-4)
  - OpenAI API communication
  - Token usage tracking
- **Anthropic Provider** (`anthropic_provider.py`):
  - Claude models integration (Claude-3 Sonnet)
  - Anthropic API communication
  - Usage metadata extraction
- **Google Provider** (`google_provider.py`):
  - Gemini models integration (Gemini-1.5 Flash/Pro)
  - Google Generative AI API
  - Response parsing and metadata
- **Ollama Provider** (`ollama_provider.py`):
  - Local LLM models (Llama2, etc.)
  - Local API communication
  - Offline text generation capability

#### **Data Models** (`models/`)
- **Session Models** (`session_models.py`):
  - `HistoryItem`: Individual browsing entry
  - `HistorySession`: Time-grouped browsing session
  - `ClusterResult`: Thematic grouping result
  - `SessionClusteringResponse`: API response format
- **LLM Models** (`llm_models.py`):
  - `LLMRequest`: Text generation request with provider settings
  - `LLMResponse`: Generated text with metadata and usage info
  - Provider-agnostic request/response handling

## React Frontend Architecture

### **Component Tree**
```
App (State Management + ExtensionBridge)
â”œâ”€â”€ Header (Logo + Action Buttons)
â”œâ”€â”€ StatusBar (Loading/Success/Error States)
â”œâ”€â”€ LoadingSpinner (Conditional Rendering)
â”œâ”€â”€ ErrorDisplay (Error Handling + Retry)
â””â”€â”€ Dashboard (Main Content)
    â”œâ”€â”€ SessionTabs (Session Navigation)
    â””â”€â”€ ClustersSection (Cluster Display)
        â”œâ”€â”€ SessionInfo (Session Metadata)
        â””â”€â”€ ClusterGrid
            â””â”€â”€ ClusterCard[] (Individual Clusters)
                â””â”€â”€ ClusterItem[] (History Items)
```

### **State Management**
- **React Hooks**: useState, useEffect for local component state
- **Props Flow**: Top-down data flow with callback props for user actions
- **ExtensionBridge**: Service layer for Chrome extension integration
- **Type Safety**: TypeScript interfaces for all props and state

### **Build Process**
- **Development**: Vite dev server at `http://localhost:5173`
- **Production**: Vite builds to `extension/dashboard-assets/`
- **Chrome Extension**: Loads React bundle from `dashboard-assets/index.js`
- **CSS**: Bundled into `dashboard-assets/assets/index.css`

## LLM Clustering Workflow

The clustering service now operates through a sophisticated two-phase LLM-driven process:

### **Phase 1: Cluster Identification**
1. **Session Analysis**: Each session is processed independently
2. **LLM Prompting**: Simplified item data (title, hostname, path, search query) sent to LLM
3. **Cluster Proposal**: LLM returns 3-8 thematic clusters with IDs, themes, and summaries
4. **Schema Validation**: Response parsed and cleaned with fallback to generic cluster

### **Phase 2: Item Assignment**
1. **Batch Processing**: Items grouped into batches of 20 for efficiency
2. **LLM Assignment**: Each batch assigned to identified clusters via LLM
3. **Error Recovery**: Fallback mechanisms ensure all items are assigned
4. **Result Assembly**: ClusterResult objects created with assigned items

### **Key Features**
- **Provider Flexibility**: Uses Google Gemini by default, configurable to other providers
- **Robust Parsing**: JSON extraction with error recovery from malformed LLM responses
- **Performance Optimization**: Batched processing reduces API calls and costs
- **Graceful Degradation**: Fallback clusters ensure system reliability

## Data Flow

1. **Data Collection**: Chrome history â†’ Background worker â†’ Local storage
2. **React Initialization**: Dashboard loads â†’ ExtensionBridge waits for services
3. **User Action**: Click Refresh â†’ React calls ExtensionBridge methods
4. **Service Layer**: ExtensionBridge â†’ SessionManager â†’ ApiClient â†’ Backend
5. **LLM Processing**: Backend receives sessions â†’ LLM cluster identification â†’ Batched item assignment
6. **AI Enhancement**: LLM service generates thematic clusters and assigns items intelligently
7. **React Update**: Backend returns clustered results â†’ React state updates â†’ UI re-renders

## Key Design Patterns

- **Extension Services Bridge Pattern**: Clean separation between React UI and Chrome extension services
- **Service Worker Pattern**: Background processing for continuous data collection
- **API Gateway Pattern**: Centralized backend service for complex processing
- **Provider Abstraction Pattern**: Unified interface for multiple LLM providers
- **Session-based Processing**: Groups related browsing activities by time
- **LLM-driven Clustering**: AI-powered thematic analysis and intelligent categorization
- **Component Composition**: React components with clear responsibilities
- **Props Down, Events Up**: Unidirectional data flow with callback props
- **Batch Processing Pattern**: Efficient LLM API usage through item batching
- **Fallback Strategy Pattern**: Robust error handling with graceful degradation
- **Separation of Concerns**: Extension handles data/APIs, React handles UI/UX

## Technology Stack

### Frontend
- **React 18**: Modern UI library with hooks and functional components
- **TypeScript**: Type safety and better developer experience
- **Vite**: Fast build tool and development server
- **Chrome Extension API**: History, Storage, Tabs permissions
- **ExtensionBridge Pattern**: Service layer for Chrome API access
- **CSS**: Component-based styling with build-time bundling

### Backend
- **FastAPI**: Modern Python web framework
- **Pydantic**: Data validation and serialization
- **httpx**: Async HTTP client for LLM API calls
- **Docker**: Containerized deployment
- **Uvicorn**: ASGI server

### LLM Integration
- **OpenAI API**: GPT models for text generation
- **Anthropic API**: Claude models for advanced reasoning
- **Google Generative AI**: Gemini models for multimodal capabilities
- **Ollama**: Local LLM models for offline processing

## Configuration

- **Session Gap**: 120 minutes between sessions
- **History Limit**: 5000 items maximum
- **API Timeout**: 30 seconds for main requests
- **Retry Logic**: 3 attempts with exponential backoff
- **LLM Clustering**: AI-powered thematic analysis with Google Gemini (primary provider)
- **Batch Size**: 20 items per LLM assignment call for efficiency
- **LLM Providers**: Configurable via environment variables
- **API Keys**: Secure environment-based configuration
- **React Build**: Outputs to extension/dashboard-assets/ for Chrome extension compatibility

## Environment Variables

- `OPENAI_API_KEY`: OpenAI API access key
- `ANTHROPIC_API_KEY`: Anthropic API access key
- `GOOGLE_API_KEY`: Google Generative AI API key
- `OLLAMA_BASE_URL`: Custom Ollama server URL (default: localhost:11434)

## Deployment

- **Extension**: Chrome Web Store (future) / Developer mode (current)
- **Backend**: Docker container on localhost:8000 (dev) / Cloud (production)
- **React Frontend**: Built into extension/dashboard-assets/ via Vite
- **Development**: Docker Compose for backend + Vite dev server for React
- **LLM Services**: External API dependencies (OpenAI, Anthropic, Google)

## Development Workflow

1. **Backend**: `.\scripts\dev_up.ps1` (Docker)
2. **Frontend**: `cd frontend && npm run dev` (Vite dev server)
3. **Extension**: Load unpacked from `extension/` folder
4. **Production**: `cd frontend && npm run build` (builds to extension/)

---

**Last Updated**: September 23, 2025
**Version**: 0.5.0
**Status**: React Frontend Integration Complete ğŸš€